!function e(t,o,r){function n(s,a){if(!o[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);throw new Error("Cannot find module '"+s+"'")}var c=o[s]={exports:{}};t[s][0].call(c.exports,function(e){var o=t[s][1][e];return n(o?o:e)},c,c.exports,e,t,o,r)}return o[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)n(r[s]);return n}({1:[function(e,t,o){"use strict";function r(e){var t=e||{};this.bufferSize=t.bufferSize||8192,this.inputChannels=t.inputChannels||1,this.outputChannels=t.outputChannels||1,this.recording=!1,this.requestedAccess=!1,this.sampleRate=16e3,this.bufferUnusedSamples=new Float32Array(0),navigator.getUserMedia||(navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}var n=e("./utils");r.prototype.onPermissionRejected=function(){console.log("Microphone.onPermissionRejected()"),this.requestedAccess=!1,this.onError("Permission to access the microphone rejeted.")},r.prototype.onError=function(e){console.log("Microphone.onError():",e)},r.prototype.onMediaStream=function(e){var t=window.AudioContext||window.webkitAudioContext;if(!t)throw new Error("AudioContext not available");this.audioContext||(this.audioContext=new t);var o=this.audioContext.createGain(),r=this.audioContext.createMediaStreamSource(e);r.connect(o),this.mic=this.audioContext.createScriptProcessor(this.bufferSize,this.inputChannels,this.outputChannels),console.log("Microphone.onMediaStream(): sampling rate is:",this.sampleRate),this.mic.onaudioprocess=this._onaudioprocess.bind(this),this.stream=e,o.connect(this.mic),this.mic.connect(this.audioContext.destination),this.recording=!0,this.requestedAccess=!1,this.onStartRecording()},r.prototype._onaudioprocess=function(e){if(this.recording){var t=e.inputBuffer.getChannelData(0);this.onAudio(this._exportDataBufferTo16Khz(new Float32Array(t)))}},r.prototype.record=function(){return navigator.getUserMedia?void(this.requestedAccess||(this.requestedAccess=!0,navigator.getUserMedia({audio:!0},this.onMediaStream.bind(this),this.onPermissionRejected.bind(this)))):void this.onError("Browser doesn't support microphone input")},r.prototype.stop=function(){this.recording&&(this.recording=!1,this.stream.stop(),this.requestedAccess=!1,this.mic.disconnect(0),this.mic=null,this.onStopRecording())},r.prototype._exportDataBufferTo16Khz=function(e){var t=null,o=e.length,r=this.bufferUnusedSamples.length;if(r>0){t=new Float32Array(r+o);for(var n=0;r>n;++n)t[n]=this.bufferUnusedSamples[n];for(n=0;o>n;++n)t[r+n]=e[n]}else t=e;for(var i=[-.037935,-89024e-8,.040173,.019989,.0047792,-.058675,-.056487,-.0040653,.14527,.26927,.33913,.26927,.14527,-.0040653,-.056487,-.058675,.0047792,.019989,.040173,-89024e-8,-.037935],s=this.audioContext.sampleRate/16e3,a=Math.floor((t.length-i.length)/s)+1,u=new ArrayBuffer(2*a),c=new DataView(u),l=0,d=32767,f=0,n=0;n+i.length-1<t.length;n=Math.round(s*f)){for(var p=0,h=0;h<i.length;++h)p+=t[n+h]*i[h];p*=d,c.setInt16(l,p,!0),l+=2,f++}var g=Math.round(s*f),v=t.length-g;if(v>0)for(this.bufferUnusedSamples=new Float32Array(v),n=0;v>n;++n)this.bufferUnusedSamples[n]=t[g+n];else this.bufferUnusedSamples=new Float32Array(0);return new Blob([c],{type:"audio/l16"})};r.prototype._exportDataBuffer=function(e){n.exportDataBuffer(e,this.bufferSize)},r.prototype.onStartRecording=function(){},r.prototype.onStopRecording=function(){},r.prototype.onAudio=function(){},t.exports=r},{"./utils":5}],2:[function(e,t,o){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var n=e("./utils"),i=r(n),s=e("./microphone"),a=r(s),u=e("./socket"),c=angular.module("WatsonApp",[]),l=new a["default"]({bufferSize:8192}),d=i["default"].createTokenGenerator();c.controller("WatsonController",["$scope",function(e){e.history=[],e.model="en-US_BroadbandModel",e.result=function(t){e.history.push(t),e.$apply()},d.getToken(function(t,o){return o?(console.error(o),!1):void u.initSocket({model:"en-US_BroadbandModel",token:t,message:{action:"start","content-type":"audio/l16;rate=16000",interim_results:!0,continuous:!0,word_confidence:!0,timestamps:!0,max_alternatives:3}},l.record.bind(l),function(e){l.onAudio=function(t){e.readyState<2&&e.send(t)}},function(t){t.results&&t.results.length>0&&t.results[0]&&t.results[0]["final"]&&e.result(t.results[0].alternatives[0].transcript.trim()||"")},function(e){console.error(e)})})}])},{"./microphone":3,"./socket":4,"./utils":5}],3:[function(e,t,o){t.exports=e(1)},{"./utils":5}],4:[function(e,t,o){var r=e("./utils"),n=(e("./Microphone"),r.createTokenGenerator()),i=o.initSocket=function(e,t,o,r,s){function a(e,t){return"undefined"==typeof e?t:e}var u,c,l=e.token,d=e.model||localStorage.getItem("currentModel"),f=e.message||{action:"start"},p=a(e.sessionPermissions,JSON.parse(localStorage.getItem("sessionPermissions"))),h=p?"0":"1",g=e.serviceURI||"wss://stream.watsonplatform.net/speech-to-text/api/v1/recognize?watson-token="+l+"&X-WDC-PL-OPT-OUT="+h+"&model="+d;try{c=new WebSocket(g)}catch(v){console.error("WS connection error: ",v)}c.onopen=function(e){u=!1,$.subscribe("hardsocketstop",function(e){console.log("MICROPHONE: close."),c.send(JSON.stringify({action:"stop"}))}),$.subscribe("socketstop",function(e){console.log("MICROPHONE: close."),c.close()}),c.send(JSON.stringify(f)),t(c)},c.onmessage=function(e){var t=JSON.parse(e.data);return t.error?(console.error(t.error),void $.publish("hardsocketstop")):("listening"===t.state&&(u?c.close():(o(c),u=!0)),void r(t,c))},c.onerror=function(e){console.log("WS onerror: ",e),console.error("Application error "+e.code+": please refresh your browser and try again"),$.publish("clearscreen"),s(e)},c.onclose=function(a){if(1006===a.code||1011===a.code){if(n.getCount()>1)throw $.publish("hardsocketstop"),new Error("No authorization token is currently available");return n.getToken(function(n,a){return a?($.publish("hardsocketstop"),!1):(e.token=n,void i(e,t,o,r,s))}),!1}return a.code>1e3?(console.error("Server error "+a.code+": please refresh your browser and try again"),!1):($.unsubscribe("hardsocketstop"),void $.unsubscribe("socketstop"))}}},{"./Microphone":1,"./utils":5}],5:[function(e,t,o){var r=function(e,t,o,r){var n=new FileReader,i=o.slice(e,t+e);n.onload=r,n.readAsArrayBuffer(i)};o.onFileProgress=function(e,t,o,n){var i=e.file,s=i.size,a=e.bufferSize||8192,u=0,c=function(e){if(u>=s)return console.log("Done reading file"),void n();if(null!=e.target.error){var l=e.target.error;return console.log("Read error: "+l),void o(l)}var d=e.target.result,f=d.byteLength;u+=f,t(d),r(u,a,i,c)};r(u,a,i,c)},o.createTokenGenerator=function(){var e=0;return{getToken:function(t){if(++e,e>5){var o=new Error("Cannot reach server");return void t(null,o)}var r="/token",n=new XMLHttpRequest;n.open("GET",r,!0),n.onload=function(e){var o=n.responseText;t(o)},n.send()},getCount:function(){return e}}},o.getToken=function(){var e=0;return function(t){if(e++,e>5){var o=new Error("Cannot reach server");return void t(null,o)}var r="/token",n=new XMLHttpRequest;n.open("GET",r,!0),n.onload=function(e){var o=n.responseText;t(o)},n.send()}}(),o.initPubSub=function(){var e=$({});$.subscribe=e.on.bind(e),$.unsubscribe=e.off.bind(e),$.publish=e.trigger.bind(e)}},{}]},{},[2]);